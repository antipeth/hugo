---
date: 2023-07-27T18:09:28+08:00
title: "从零开始的计算机网络4-6"
draft: false
description: "四.网络层"
url: "/learn/1-4-6"
keywords:
- 计算机网络
categories:
- 学
tags:
- 计算机网络
---

# 路由选择协议概述

静态路由选择

- 由**人工配置**的网络路由、默认路由、特定主机路由、黑洞路由等都属于静态路由。

- 这种人工配置方式简单、开销小。

- 但不能及时适应网络状态(流量、拓扑等)的变化。

- 一般只在小规模网络中采用。

动态路由选择

- 路由器通过路由选择协议**自动获取路由信息**。

- 比较复杂、开销比较大。

- **能较好地适应网络状态的变化**。

- 适用于**大规模网络**。

因特网所采用的路由选择协议的主要特点

- 自适应：动态路由选择，能较好地适应网络状态的变化

- 分布式：路由器之间交换路由信息

- 分层次：将整个因特网划分为许多较小的自治系统AS(Autonomous System)

因特网采用**分层次**的路由选择协议

![](https://img.0pt.im/computernet/4-6/4-6-1.png)

域间路由选择采用外部网关协议EGP

域内路由选择采用内部网关协议IGP

> 只是路由选择协议的分类名称，不是具体的路由选择协议。网关一词是因为在早期

常见的路由选择协议

路由选择协议

内部网关协议IGP

- 路由信息协议RIP    基于距离向量，RIP在因特网上最早使用

- 内部网关路由协议IGRP    基于距离向量，是思科早期私有的协议，现在已被EIGRP取代

- 增强型内部网关路由协议EIGRP    思科私有的，用来取代IGRP的混合型路由协议(结合距离向量和链路状态)

- 开放式最短路径优先OSPF    基于链路状态，在各种网络中广泛使用

- 中间系统到中间系统IS-IS    基于链路状态，是ISP骨干网上最长常用的IGP协议

外部网关协议EGP

- 边界网关协议BGP

路由器的基本结构

![](https://img.0pt.im/computernet/4-6/4-6-2.png)

路由表一般仅包含从目的网络到下一跳的映射

路由表需要对网络拓扑变化的计算最优化

转发表是从路由表得出的
转发表的结构应当使查找过程最优化

> 为方便理解，不严格区分路由表和转发表。

### 路由信息协议RIP的基本工作原理

**路由信息协议RIP**(Routing Information Protocol)是内部网关协议IGP中最先得到广泛使用的协议之一，其相关标准文档为RFC 1058。

RIP要求自治系统AS内的每一个路由器都要维护从它自己到AS内其他每一个网络的距离记录。这是一组距离，称为“**距离向量D-V(Distance-Vector)**”。

RIP使用**跳数**(Hop Count)作为度量(Metric)**来衡量到达目的网络的距离**。

- 路由器到直连网络的距离定义为1。

- 路由器到非直连网络的距离定义为所经过的路由器数加1。

- 允许一条路径最多只能包含15个路由器。**“距离”等于16时相当于不可达**。因此，**RIP只适用于小型互联网**。

![](https://img.0pt.im/computernet/4-6/4-6-3.png)

RIP认为**好的路由**就是“距离短”的路由，也就是所**通过路由器数量最少的路由**。当到达同一目的网络有多条“距离相等”的路由时，可以进行**等价负载均衡**。

RIP包含以下三个要点:

- **和谁交换信息**    仅和**相邻路由器**交换信息

- **交换什么信息**    自己的路由表

- **何时交换信息**    **周期性交换**（例如每30秒)

RIP基本工作过程

![](https://img.0pt.im/computernet/4-6/4-6-4.png)

路由器刚开始工作时，**只知道自己到直连网络的距离为1**。

每个路由器仅**和相邻路由器周期性地交换并更新路由信息**。

若干次交换和更新后，**每个路由器都知道到达本AS内各网络的最短距离和下一跳地址**，称为收敛。

![](https://img.0pt.im/computernet/4-6/4-6-5.png)

RIP的路由条目的更新规则

![](https://img.0pt.im/computernet/4-6/4-6-6.png)

C将其路由表发给D，结果D改造，对D原有路由表进行更新。

例题：某自治系统内采用RIP协议，若该自治系统内的路由器R1收到其邻居路由器R2的距离矢量，距离矢量中包含信息< net1,16 >，则能得出的结论是

A.R2可以经过R1到达net1，跳数为17    B.R2可以到达net1，跳数为16

C.R1可以经过R2到达net1，跳数为17    D.R1不能经过R2到达net1

解析：在RIP协议中，距离16表明目的网络不可达。因此，R2无法到达net1，R1也无法通过R2到达net1。选D

RIP存在“**坏消息传播得慢**”的问题

![](https://img.0pt.im/computernet/4-6/4-6-7.png)

R1与N1连接出现故障。将N1改成16跳，并发送路由信息给R2，而此时R2也发路由信息给R1.若R2发送的路由信息先到，R1更新路由表N1为3跳，发送回R2，R2收到后，更新自身路由表N1为4跳，再发回R1......直到R1R2路由表关于N1的均为16跳才停止，这叫做收敛。

“坏消息传播得慢”又称为**路由环路**或**距离无穷计数**问题，这是**距离向量算法的一个固有问题**。可以采取多种措施**减少**出现该问题的概率或减小该问题带来的危害。

- **限制最大路径距离**为15（16表示不可达)

- 当路由表发生变化时就立即发送更新报文（即“**触发更新**”)，而不仅是周期性发送

- 让路由器记录收到某特定路由信息的接口，而不让同一路由信息再通过此接口向反方向传送（即“**水平分割**”）

例题：假设R1、R2、R3采用RIP协议交换路由信息，且均已收敛。若R3检测到网络201.1.2.0/25不可达，并向R2通告一次新的距离向量，则R2更新后，其到达该网络的距离是

A.2    B.3    C.16    D.17

![](https://img.0pt.im/computernet/4-6/4-6-8.png)

解析：

由题知，R3与201.1.2.0/25连接之间出现故障，R3将其改为201.1.2.0/25为16跳，并向R2通告一次新的距离向量。则R2也将201.1.2.0/25改为为16跳。

由知，R2更新后，则是R1给R2发送了RIP更新报文，R2又将201.1.2.0/25改为3跳。

选B

### 开放最短路径优先OSPF的基本工作原理

开放最短路径优先OSPF(Open Shortest Path First)，是为克服RIP的缺点在1989年开发出来

- “开放”表明OSPF协议不是受某一家厂商控制，而是**公开发表**的。

- “最短路径优先”是因为使用了Dijkstra提出的**最短路径算法**SPF。

OSPF是**基于链路状态**的，而不像RIP那样是基于距离向量的。

OSPF采用SPF算法计算路由，从算法上保证了**不会产生路由环路**。

OSPF**不限制网络规模**，更新效率高，**收敛速度快**。

链路状态是指本路由器都**和哪些路由器相邻**，以及相应**链路的“代价”**(cost)。

- “代价”用来表示费用、距离、时延、带宽，等等。这些都由网络管理人员来决定。

举例：思科路由器中OSPF计算代价的方法: 100Mbps/链路带宽

计算结果小于1的值仍记为1;大于1且有小数的，舍去小数。

![](https://img.0pt.im/computernet/4-6/4-6-10.png)

OSPF相邻路由器之间通过交互**问候(Hello)分组**，建立和维护**邻居关系**。

- Hello分组封装在lP数据报中，发往组播地址224.0.0.5;

- 发送周期为10秒

- 40秒未收到来自邻居路由器的Hello分组，则认为该邻居路由器不可达。

![](https://img.0pt.im/computernet/4-6/4-6-11.png)

![](https://img.0pt.im/computernet/4-6/4-6-12.png)

使用OSPF的每个路由器都会产生**链路状态通告**LSA(Link State Advertisement)。LSA中包含以下内容:

- 直连网络的链路状态信息

- 邻居路由器的链路状态信息

LSA被封装在**链路状态更新分组LSU**中，采用**洪泛法**发送。

使用OSPF的每个路由器都有一个**链路状态数据库LSDB**，用于存储LSA。

通过各路由器洪泛发送封装有自己LSA的LSU分组，各路由器的LSDB最终将达到一致。

![](https://img.0pt.im/computernet/4-6/4-6-13.png)

使用OSPF的各路由器**基于LSDB进行最短路径优先SPF计算**，构建出各自到达其他各路由器的最短路径，即构建各自的路由表。

![](https://img.0pt.im/computernet/4-6/4-6-14.png)

OSPF有以下五种分组类型

- 类型1，**问候**(Hello)分组    用来发现和维护邻居路由器的可达性。

- 类型2，**数据库描述**(Database Description)分组    向邻居路由器给出自己的链路状态数据库中的所有链路状态项目的摘要信息

- 类型3，**链路状态请求**(Link State Request)分组    向邻居路由器请求发送某些链路状态项目的详细信息。

- 类型4，**链路状态更新**(Link State Update)分组    路由器使用这种分组将其链路状态进行洪泛发送，即用洪泛法对全网更新链路状态。

- 类型5，**链路状态确**认(Link State Acknowledgment)分组    这是对链路状态更新分组的确认分组。

OSPF的基本工作过程

![](https://img.0pt.im/computernet/4-6/4-6-15.png)

OSPF在多点接入网络中路由器邻居关系的建立

- 选举指定路由器DR(designated router)和备用的指定路由器BDR(backup designated router)

- 所有的非DR/BDR只与DR/BDR建立邻居关系

- 非DR/BDR之间通过DR/BDR交换信息

- DR出了故障就用BDR

![](https://img.0pt.im/computernet/4-6/4-6-16.png)

为了使OSPF能够用于规模很大的网络，OSPF把一个自治系统再划分为若干个更小的范围，叫做**区域**(Area)

![](https://img.0pt.im/computernet/4-6/4-6-17.png)

区域内路由器IR(internal router): R1,R2,R8,49

区域边界路由器ABR(area border router): R3,R4,R7

主干路由器BBR(backbone router): R3,R4,R5,R6,R7

自治系统边界路由器ASBR(AS border router): R6

### 边界网关协议BGP的基本工作原理

因特网采用分层次的路由选择协议

内部网关协议IGP（例如路由信息协议RIP或开放最短路径优先OSPF）

- 设法使分组在一个自治系统内尽可能有效地从源网络传输到目的网络

- 无需考虑自治系统外部其他方面的策略

外部网关协议EGP（例如边界网关协议BGP）

- 在不同自治系统内，度量路由的“代价”(距离，带宽，费用等）可能不同。因此，对于自治系统之间的路由选择，使用“代价”作为度量来寻找最佳路由是不行的。

外部网关协议EGP（例如边界网关协议BGP）

- 在不同自治系统内，度量路由的“代价”(距离，带宽，费用等）可能不同。因此，对于自治系统之间的路由选择，使用“代价”作为度量来寻找最佳路由是不行的。

- 自治系统之间的路由选择必须考虑相关策略(政治，经济，安全等)

- BGP只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子)，而并非要寻找一条最佳路由

在配置BGP时，每个自治系统的管理员要选择至少一个路由器作为该自治系统的“**BGP发言人**"不同自治系统的BGP发言人要交换路由信息，首先必须建立**TCP连接**，端口号为179

- 在此TCP连接上交换BGP报文以建立**BGP会话**

- 利用BGP会话**交换路由信息**（例如，增加新的路由，或撤销过时的路由，以及报告出错的情况等)

- 使用TCP连接交换路由信息的两个BGP发言人，彼此称为对方的**邻站(**neighbor)或**对等站**(peer)BGP发言人除了运行BGP外，还必须运行自己所在自治系统所使用的内部网关协议IGP，例如OSPF或RIlP。

BGP发言人**交换网络可达性的信息**（要到达某个网络所要经过的一系列自治系统)

当BGP发言人互相交换了网络可达性的信息后，各BGP发言人就**根据**所采用的**策略**从收到的路由信息中**找出到达各自治系统的较好的路由**。也就是构造出树形结构、**不存在回路的自治系统连通图**。

![](https://img.0pt.im/computernet/4-6/4-6-18.png)

BGP适用于多级结构的因特网

![](https://img.0pt.im/computernet/4-6/4-6-19.png)

BGP-4有以下四种报文

- OPEN（打开）报文:用来与相邻的另一个BGP发言人建立关系，使通信初始化。

- UPDATE（更新）报文:用来通告某一路由的信息，以及列出要撤销的多条路由。

- KEEPALIVE（保活）报文:用来周期性地证实邻站的连通性。

- NOTIFICATION（通知）报文:用来发送检测到的差错。

例题：R1与R2之间利用哪个路由协议交换路由信息?该路由协议的报文被封装到哪个协议的分组中进行传输?

![](https://img.0pt.im/computernet/4-6/4-6-20.png)

解析：

R1和R2分别位于两个不同的自治系统AS1和AS2中;

自治系统之间需要使用外部网关协议EGP这一类协议，具体为**边界网关协议BGP**，目前使用最多的版本是BGP-4;

BGP-4报文被封装在**TCP报文段**中进行传输。

例题：直接封装RIP、OSPF、BGP报文的协议分别是

A.TCP、UDP、IP    B.TCP、IP、UDP    C.UDP、TCP、IP    D.UDP、IP、TCP

解析：

![](https://img.0pt.im/computernet/4-6/4-6-21.png)
